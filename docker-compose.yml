version: '3.8'

services:
  # Node 1: Bootnode & Primary Sealer
  node-1:
    image: ethereum/client-go:v1.13.15
    container_name: vision-node-1
    restart: unless-stopped
    networks:
      vision-net:
        ipv4_address: 172.20.0.11
    ports:
      - "8545:8545" # RPC
      - "30303:30303" # P2P
    volumes:
      - ./deploy/v2-testnet/node1:/root/.ethereum
      - ./deploy/v2-testnet/static-nodes.json:/root/.ethereum/static-nodes.json:ro
    command: >
      --networkid 3151909 --http --http.addr "0.0.0.0" --http.port 8545 --http.api "eth,net,web3,admin,debug,clique" --http.corsdomain "*" --allow-insecure-unlock --unlock "0xf39Fd6e51aad88F6F4ce6aB8827279cffFb92266" --password /root/.ethereum/password.txt --mine --miner.etherbase "0xf39Fd6e51aad88F6F4ce6aB8827279cffFb92266" --nat extip:172.20.0.11 --maxpeers 25
    deploy:
      resources:
        limits:
          memory: 2G
          cpus: '0.5'

  # Node 2: Validator 1
  node-2:
    image: ethereum/client-go:v1.13.15
    container_name: vision-node-2
    restart: unless-stopped
    networks:
      vision-net:
        ipv4_address: 172.20.0.12
    ports:
      - "8546:8545" # RPC mapped to 8546
      - "30304:30303" # P2P mapped to 30304
    volumes:
      - ./deploy/v2-testnet/node2:/root/.ethereum
      - ./deploy/v2-testnet/static-nodes.json:/root/.ethereum/static-nodes.json:ro
    command: >
      --networkid 3151909 --http --http.addr "0.0.0.0" --http.port 8545 --http.api "eth,net,web3,admin" --bootnodes "enode://b51e15b9ce0121d142bf7adeeaaa66b5bfcb07fe11b1927156623afcf97c4e5a1f4fbafeba8320f9490caa2607b50df97fce31dbdbfc21960e3465ad81ebba22@172.20.0.11:30303" --nat extip:172.20.0.12 --maxpeers 25
    deploy:
      resources:
        limits:
          memory: 1G
          cpus: '0.25'

  # Node 3: Validator 2
  node-3:
    image: ethereum/client-go:v1.13.15
    container_name: vision-node-3
    restart: unless-stopped
    networks:
      vision-net:
        ipv4_address: 172.20.0.13
    ports:
      - "8547:8545"
      - "30305:30303"
    volumes:
      - ./deploy/v2-testnet/node3:/root/.ethereum
      - ./deploy/v2-testnet/static-nodes.json:/root/.ethereum/static-nodes.json:ro
    command: >
      --networkid 3151909 --http --http.addr "0.0.0.0" --http.port 8545 --http.api "eth,net,web3,admin" --bootnodes "enode://b51e15b9ce0121d142bf7adeeaaa66b5bfcb07fe11b1927156623afcf97c4e5a1f4fbafeba8320f9490caa2607b50df97fce31dbdbfc21960e3465ad81ebba22@172.20.0.11:30303" --nat extip:172.20.0.13 --maxpeers 25
    deploy:
      resources:
        limits:
          memory: 1G
          cpus: '0.25'

  # Node 4: Validator 3
  node-4:
    image: ethereum/client-go:v1.13.15
    container_name: vision-node-4
    restart: unless-stopped
    networks:
      vision-net:
        ipv4_address: 172.20.0.14
    ports:
      - "8548:8545"
      - "30306:30303"
    volumes:
      - ./deploy/v2-testnet/node4:/root/.ethereum
      - ./deploy/v2-testnet/static-nodes.json:/root/.ethereum/static-nodes.json:ro
    command: >
      --networkid 3151909 --http --http.addr "0.0.0.0" --http.port 8545 --http.api "eth,net,web3,admin" --bootnodes "enode://b51e15b9ce0121d142bf7adeeaaa66b5bfcb07fe11b1927156623afcf97c4e5a1f4fbafeba8320f9490caa2607b50df97fce31dbdbfc21960e3465ad81ebba22@172.20.0.11:30303" --nat extip:172.20.0.14 --maxpeers 25
    deploy:
      resources:
        limits:
          memory: 1G
          cpus: '0.25'

  # Node 5: Validator 4
  node-5:
    image: ethereum/client-go:v1.13.15
    container_name: vision-node-5
    restart: unless-stopped
    networks:
      vision-net:
        ipv4_address: 172.20.0.15
    ports:
      - "8549:8545"
      - "30307:30303"
    volumes:
      - ./deploy/v2-testnet/node5:/root/.ethereum
      - ./deploy/v2-testnet/static-nodes.json:/root/.ethereum/static-nodes.json:ro
    command: >
      --networkid 3151909 --http --http.addr "0.0.0.0" --http.port 8545 --http.api "eth,net,web3,admin" --bootnodes "enode://b51e15b9ce0121d142bf7adeeaaa66b5bfcb07fe11b1927156623afcf97c4e5a1f4fbafeba8320f9490caa2607b50df97fce31dbdbfc21960e3465ad81ebba22@172.20.0.11:30303" --nat extip:172.20.0.15 --maxpeers 25
    deploy:
      resources:
        limits:
          memory: 1G
          cpus: '0.25'

  # Kafka & Zookeeper for Shared Sequencer
  zookeeper:
    image: confluentinc/cp-zookeeper:7.0.1
    container_name: vision-zookeeper
    networks:
      vision-net:
        ipv4_address: 172.20.0.21
    ports:
      - "2181:2181"
    environment:
      ZOOKEEPER_CLIENT_PORT: 2181
      ZOOKEEPER_TICK_TIME: 2000

  kafka:
    image: confluentinc/cp-kafka:7.0.1
    container_name: vision-kafka
    networks:
      vision-net:
        ipv4_address: 172.20.0.22
    depends_on:
      - zookeeper
    ports:
      - "9092:9092"
    environment:
      KAFKA_BROKER_ID: 1
      KAFKA_ZOOKEEPER_CONNECT: zookeeper:2181
      KAFKA_ADVERTISED_LISTENERS: PLAINTEXT://46.224.221.201:9092
      KAFKA_LISTENER_SECURITY_PROTOCOL_MAP: PLAINTEXT:PLAINTEXT
      KAFKA_INTER_BROKER_LISTENER_NAME: PLAINTEXT
      KAFKA_OFFSETS_TOPIC_REPLICATION_FACTOR: 1

networks:
  vision-net:
    driver: bridge
    ipam:
      config:
        - subnet: 172.20.0.0/16
